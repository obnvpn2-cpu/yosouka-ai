<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á´∂È¶¨‰∫àÊÉ≥ÂÆ∂ÂàÜÊûêAI</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone (JSXÂ§âÊèõÁî®) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .card h2 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .radio-item, .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background: #f5f5f5;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-item:hover, .checkbox-item:hover {
            background: #667eea;
            color: white;
        }

        .radio-item input, .checkbox-item input {
            margin-right: 8px;
            cursor: pointer;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 5px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }

        .results-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .results-summary h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .summary-item .label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .summary-item .value {
            color: #667eea;
            font-size: 1.8em;
            font-weight: bold;
        }

        .top3-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .top3-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
        }

        .top3-card h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .top3-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .top3-item .rank {
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 10px;
        }

        .top3-item .name {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .top3-item .stats {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .predictor-list {
            display: grid;
            gap: 15px;
        }

        .predictor-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .predictor-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .predictor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .predictor-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .predictor-rank {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .predictor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .stat {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 3px;
        }

        .stat-value {
            color: #333;
            font-weight: bold;
            font-size: 1.1em;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-results h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API„ÅÆ„Éô„Éº„ÇπURL
        const API_BASE_URL = 'http://localhost:8000';

        function App() {
            // Áä∂ÊÖãÁÆ°ÁêÜ
            const [options, setOptions] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [results, setResults] = useState(null);
            
            // „Éï„Ç©„Éº„É†„ÅÆÁä∂ÊÖã
            const [venue, setVenue] = useState('');
            const [trackType, setTrackType] = useState('');
            const [distances, setDistances] = useState([]);
            const [grade, setGrade] = useState('');

            // ÂàùÊúüÂåñ: ÈÅ∏ÊäûËÇ¢„ÇíÂèñÂæó
            useEffect(() => {
                fetchOptions();
            }, []);

            const fetchOptions = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/options`);
                    const data = await response.json();
                    setOptions(data);
                } catch (err) {
                    setError('ÈÅ∏ÊäûËÇ¢„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
                }
            };

            const handleDistanceChange = (distance) => {
                setDistances(prev => {
                    if (prev.includes(distance)) {
                        return prev.filter(d => d !== distance);
                    } else {
                        return [...prev, distance];
                    }
                });
            };

            const handleSearch = async () => {
                setLoading(true);
                setError(null);
                setResults(null);

                try {
                    const payload = {
                        venue: venue || null,
                        track_type: trackType || null,
                        distances: distances.length > 0 ? distances : null,
                        grade: grade || null,
                        sort_by: 'hit_rate',
                        limit: 50
                    };

                    const response = await fetch(`${API_BASE_URL}/api/search`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    setResults(data);
                } catch (err) {
                    setError('Ê§úÁ¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleReset = () => {
                setVenue('');
                setTrackType('');
                setDistances([]);
                setGrade('');
                setResults(null);
            };

            if (!options) {
                return (
                    <div className="container">
                        <div className="card">
                            <div className="loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    {/* „Éò„ÉÉ„ÉÄ„Éº */}
                    <div className="header">
                        <h1>üèá Á´∂È¶¨‰∫àÊÉ≥ÂÆ∂ÂàÜÊûêAI</h1>
                        <p>Êù°‰ª∂„ÇíÊåáÂÆö„Åó„Å¶„ÄÅ„Åä„Åô„Åô„ÇÅ„ÅÆ‰∫àÊÉ≥ÂÆ∂„ÇíË¶ã„Å§„Åë„Çà„ÅÜ</p>
                    </div>

                    {/* Ê§úÁ¥¢„Éï„Ç©„Éº„É† */}
                    <div className="card">
                        <h2>Ê§úÁ¥¢Êù°‰ª∂</h2>

                        {error && <div className="error">{error}</div>}

                        {/* Á´∂È¶¨Â†¥ */}
                        <div className="form-group">
                            <label>Á´∂È¶¨Â†¥</label>
                            <div className="radio-group">
                                <div className="radio-item">
                                    <input
                                        type="radio"
                                        name="venue"
                                        checked={venue === ''}
                                        onChange={() => setVenue('')}
                                    />
                                    <span>ÊåáÂÆö„Å™„Åó</span>
                                </div>
                                {options.venues.map(v => (
                                    <div key={v} className="radio-item">
                                        <input
                                            type="radio"
                                            name="venue"
                                            checked={venue === v}
                                            onChange={() => setVenue(v)}
                                        />
                                        <span>{v}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* „Ç≥„Éº„ÇπÁ®ÆÂà• */}
                        <div className="form-group">
                            <label>„Ç≥„Éº„ÇπÁ®ÆÂà•</label>
                            <div className="radio-group">
                                <div className="radio-item">
                                    <input
                                        type="radio"
                                        name="track_type"
                                        checked={trackType === ''}
                                        onChange={() => setTrackType('')}
                                    />
                                    <span>ÊåáÂÆö„Å™„Åó</span>
                                </div>
                                {options.track_types.filter(t => t !== 'ÈöúÂÆ≥').map(t => (
                                    <div key={t} className="radio-item">
                                        <input
                                            type="radio"
                                            name="track_type"
                                            checked={trackType === t}
                                            onChange={() => setTrackType(t)}
                                        />
                                        <span>{t}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Ë∑ùÈõ¢ */}
                        <div className="form-group">
                            <label>Ë∑ùÈõ¢ÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</label>
                            <div className="checkbox-group">
                                {options.distances.filter(d => d >= 1000 && d <= 3000).map(d => (
                                    <div key={d} className="checkbox-item">
                                        <input
                                            type="checkbox"
                                            checked={distances.includes(d)}
                                            onChange={() => handleDistanceChange(d)}
                                        />
                                        <span>{d}m</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* „Ç∞„É¨„Éº„Éâ */}
                        <div className="form-group">
                            <label>„Ç∞„É¨„Éº„Éâ</label>
                            <div className="radio-group">
                                <div className="radio-item">
                                    <input
                                        type="radio"
                                        name="grade"
                                        checked={grade === ''}
                                        onChange={() => setGrade('')}
                                    />
                                    <span>ÊåáÂÆö„Å™„Åó</span>
                                </div>
                                {options.grades.map(g => (
                                    <div key={g} className="radio-item">
                                        <input
                                            type="radio"
                                            name="grade"
                                            checked={grade === g}
                                            onChange={() => setGrade(g)}
                                        />
                                        <span>{g}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* „Éú„Çø„É≥ */}
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <button
                                className="btn"
                                onClick={handleSearch}
                                disabled={loading}
                                style={{ flex: 1 }}
                            >
                                {loading ? 'Ê§úÁ¥¢‰∏≠...' : 'üîç Ê§úÁ¥¢'}
                            </button>
                            <button
                                className="btn"
                                onClick={handleReset}
                                style={{ flex: 1, background: '#6c757d' }}
                            >
                                „É™„Çª„ÉÉ„Éà
                            </button>
                        </div>
                    </div>

                    {/* Ê§úÁ¥¢ÁµêÊûú */}
                    {results && (
                        <div className="card">
                            <h2>Ê§úÁ¥¢ÁµêÊûú</h2>

                            {results.total_count === 0 ? (
                                <div className="no-results">
                                    <h3>Ë©≤ÂΩì„Åô„Çã‰∫àÊÉ≥ÂÆ∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</h3>
                                    <p>Êù°‰ª∂„ÇíÁ∑©„ÇÅ„Å¶ÂÜçÂ∫¶Ê§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                                </div>
                            ) : (
                                <>
                                    {/* „Çµ„Éû„É™„Éº */}
                                    <div className="results-summary">
                                        <h3>üìä ÁµêÊûú„Çµ„Éû„É™„Éº</h3>
                                        <div className="summary-grid">
                                            <div className="summary-item">
                                                <div className="label">Ë©≤ÂΩì‰∫àÊÉ≥ÂÆ∂Êï∞</div>
                                                <div className="value">{results.total_count}‰∫∫</div>
                                            </div>
                                            <div className="summary-item">
                                                <div className="label">Âπ≥ÂùáÁöÑ‰∏≠Áéá</div>
                                                <div className="value">{results.avg_hit_rate.toFixed(1)}%</div>
                                            </div>
                                            <div className="summary-item">
                                                <div className="label">ÊúÄÈ´òÁöÑ‰∏≠Áéá</div>
                                                <div className="value">{results.max_hit_rate.toFixed(1)}%</div>
                                            </div>
                                            <div className="summary-item">
                                                <div className="label">Á∑è‰∫àÊÉ≥Êï∞</div>
                                                <div className="value">{results.total_predictions}‰ª∂</div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* TOP3 */}
                                    <div className="top3-section">
                                        <div className="top3-card">
                                            <h3>üèÜ ÁöÑ‰∏≠ÁéáTOP3</h3>
                                            {results.predictors.slice(0, 3).map((p, idx) => (
                                                <div key={p.predictor_id} className="top3-item">
                                                    <div className="rank">{idx + 1}‰Ωç</div>
                                                    <div className="name">{p.predictor_name}</div>
                                                    <div className="stats">
                                                        ÁöÑ‰∏≠Áéá: {p.hit_rate.toFixed(1)}% ({p.hit_count}/{p.prediction_count})
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* ‰∫àÊÉ≥ÂÆ∂„É™„Çπ„Éà */}
                                    <h3 style={{ marginBottom: '15px', color: '#333' }}>üìã Ë©≤ÂΩì‰∫àÊÉ≥ÂÆ∂„É™„Çπ„Éà</h3>
                                    <div className="predictor-list">
                                        {results.predictors.map((p, idx) => (
                                            <div key={p.predictor_id} className="predictor-item">
                                                <div className="predictor-header">
                                                    <div className="predictor-name">{p.predictor_name}</div>
                                                    <div className="predictor-rank">{idx + 1}‰Ωç</div>
                                                </div>
                                                <div className="predictor-stats">
                                                    <div className="stat">
                                                        <div className="stat-label">‰∫àÊÉ≥Êï∞</div>
                                                        <div className="stat-value">{p.prediction_count}‰ª∂</div>
                                                    </div>
                                                    <div className="stat">
                                                        <div className="stat-label">ÁöÑ‰∏≠Áéá</div>
                                                        <div className="stat-value">{p.hit_rate.toFixed(1)}%</div>
                                                    </div>
                                                    <div className="stat">
                                                        <div className="stat-label">ÁöÑ‰∏≠Êï∞</div>
                                                        <div className="stat-value">{p.hit_count}‰ª∂</div>
                                                    </div>
                                                    {p.avg_roi !== null && (
                                                        <div className="stat">
                                                            <div className="stat-label">Âπ≥ÂùáROI</div>
                                                            <div className="stat-value">{p.avg_roi.toFixed(1)}%</div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // React„Ç¢„Éó„É™„Çí„Éû„Ç¶„É≥„Éà
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
